---
- name: Setup Counter Strike Source server
  hosts: cs_servers
  tasks:
    - name: Install SteamCMD dependencies
      yum:
        name: "{{ cs_packages }}"
        state: latest

    - name: Create SteamCMD dir
      file:
        state: directory
        group: "{{ steam_user }}"
        owner: "{{ steam_user }}"
        path: "{{ steamcmd_path }}"


    - name: Download SteamCMD
      unarchive:
        dest: "{{ steamcmd_path }}"
        group: "{{ steam_user }}"
        owner: "{{ steam_user }}"
        remote_src: True
        src: https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz
        creates: "{{ steamcmd_path }}/steamcmd.sh"

    - name: Download CSS
      shell:
        cmd: "sudo -u {{ steam_user }} {{ steamcmd_path }}/steamcmd.sh +login anonymous +force_install_dir {{ css_path }} +app_update {{ css_app_id }} validate +quit"
        creates: "{{ css_path }}"
      #become_user: "{{ steam_user }}"
      #become_method: su

    # Next two tasks resolve a little bug
    - name: Create sdk32 folder
      file:
        path: "/home/{{ steam_user }}/.steam/sdk32"
        state: directory
        owner: "{{ steam_user }}"
        group: "{{ steam_user }}"

    - name: Create Symlink for steamclient.so
      file:
        src: "{{ steamcmd_path }}/linux32/steamclient.so"
        path: "/home/{{ steam_user }}/.steam/sdk32/steamclient.so"
        state: link
        owner: "{{ steam_user }}"
        group: "{{ steam_user }}"

    - name: Create CSS service
      template:
        src: files/css.service.j2
        dest: /etc/systemd/system/cssd.service
      notify:
        - Daemon reload
        - Restart cssd

    - name: Copy CSS server config
      template:
        src: "files/css_config/{{ item }}"
        dest: "{{ css_path }}/cstrike/cfg/{{ item }}"
        owner: root
        group: root
      loop: "{{ css_config_files }}"
      notify: Restart cssd

  handlers:
    - name: Daemon reload
      systemd:
        daemon_reload: True

    - name: Restart cssd
      service:
        name: cssd
        state: restarted
        enabled: True
